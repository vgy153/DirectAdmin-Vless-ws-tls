process.on("uncaughtException", () => {});
process.on("unhandledRejection", () => {});

// ====== 只修改两个核心变量 UUID/DOMAIN ======
const UUID = (process.env.UUID || "abcd1eb2-1c20-345a-96fa-cdf394612345").trim();   // 替换"双引号中的UUID"
const DOMAIN = (process.env.DOMAIN || "abc.domain.dpdns.org").trim();               // 替换"双引号中的完整域名"

// Panel 配置
const NAME = "DirectAdmin-easyshare";
const LISTEN_PORT = Number(process.env.PORT);
if (!LISTEN_PORT) throw new Error("DirectAdmin PORT not assigned");

const BEST_DOMAINS = [
    "www.visa.cn",
    "www.shopify.com",
    "store.ubi.com",
    "www.wto.org",
    "time.is",
    "www.udemy.com",
];

// ============================================================
// =============== 模块加载区 ================================
// ============================================================
const http = require('http');
const net = require('net');
const { WebSocketServer, createWebSocketStream } = require("ws");

// ============================================================
// =============== WebSocket Path ============================
// ============================================================
const WS_PATH = `/${UUID}/ws`; // 避免 HTTP / UUID 冲突

// ============================================================
// =============== 生成 VLESS 节点链接函数 ====================
// ============================================================
function generateLink(address) {
    return `vless://${UUID}@${address}:443?encryption=none&security=tls&sni=${DOMAIN}&fp=chrome&type=ws&host=${DOMAIN}&path=${encodeURIComponent(WS_PATH)}#${NAME}`;
}

// ============================================================
// =============== HTTP 服务 ==================================
// ============================================================
const server = http.createServer((req, res) => {
    if (req.headers.upgrade) {
        res.writeHead(426);
        return res.end();
    }

    if (req.url === "/") {
        res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
        return res.end(`VLESS WS TLS Running\n访问 /${UUID} 查看所有节点\n`);
    }

    if (req.url === `/${UUID}`) {
        let txt = "═════ EasyShare VLESS-WS-TLS 节点 ═════\n\n";
        BEST_DOMAINS.forEach(d => txt += generateLink(d) + "\n\n");
        txt += "节点已全部生成，可全选复制使用。\n";
        res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
        return res.end(txt);
    }

    res.writeHead(404);
    res.end("404 Not Found");
});

// ============================================================
// =============== WebSocket 后端 ============================
// ============================================================
const wss = new WebSocketServer({ server, path: WS_PATH, maxPayload: 256 * 1024 });
const uuid_clean = UUID.replace(/-/g, "");

wss.on("connection", ws => {
    let tcp = null;

    ws.once("message", msg => {
        if (!Buffer.isBuffer(msg) || msg.length < 18) { ws.close(); return; }

        const [VERSION] = msg;
        const id = msg.slice(1, 17);

        // UUID 校验
        for (let i = 0; i < 16; i++) {
            if (id[i] !== parseInt(uuid_clean.substr(i * 2, 2), 16)) {
                ws.close();
                return;
            }
        }

        let p = msg[17] + 19;
        const port = msg.slice(p, p += 2).readUInt16BE();
        const ATYP = msg.slice(p, p += 1).readUInt8();
        let host = "";

        if (ATYP === 1) { // IPv4
            host = msg.slice(p, p += 4).join(".");
        } else if (ATYP === 2) { // domain
            const len = msg.slice(p, p + 1).readUInt8();
            host = msg.slice(p + 1, p + 1 + len).toString();
            p += 1 + len;
        } else if (ATYP === 3) { // IPv6
            host = msg.slice(p, p += 16)
                .reduce((s, b, i, a) => (i % 2 ? s.concat(a.slice(i - 1, i + 1)) : s), [])
                .map(b => b.readUInt16BE(0).toString(16))
                .join(":");
        } else { ws.close(); return; }

        ws.send(new Uint8Array([VERSION, 0]));

        tcp = net.connect({ host, port }, () => {
            tcp.write(msg.slice(p));
            createWebSocketStream(ws).pipe(tcp).pipe(createWebSocketStream(ws));
        });

        ws.on("message", data => { if (tcp && tcp.writable && data.length <= 64 * 1024) tcp.write(data); });
        tcp.on("data", chunk => { if (ws.readyState === ws.OPEN) ws.send(chunk); });
        tcp.on("error", () => { try { ws.close(); } catch {} });
    });

    ws.on("close", () => { try { tcp && tcp.destroy(); } catch {} });
    ws.on("error", () => {});
});

// ============================================================
// =============== 启动 ============================
// ============================================================
server.listen(LISTEN_PORT, "127.0.0.1");
